<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thermostat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #08090a; --bg2: #1e1e1e; --bg3: #1a1b1e;
            --border: #2a2b2e; --text: #f5f5f5; --text2: rgba(255,255,255,0.6); --text3: rgba(255,255,255,0.9);
            --accent: #00d4aa; --accent-glow: rgba(0,212,170,0.15);
            --danger: #ff6b6b;
            --blue: #3d8bd4; --blue-glow: rgba(61,139,212,0.20); --blue-border: rgba(61,139,212,0.5);
            --timeline-bg: #08090a; --timeline-grid: rgba(255,255,255,0.05); --timeline-text: #ffffff;
        }
        .light-mode {
            --bg2: #ffffff; --bg3: #f8f9fa;
            --border: #e0e0e0; --text: #1a1a1a; --text2: rgba(0,0,0,0.55); --text3: rgba(0,0,0,0.75);
            --accent: #00a88a; --accent-glow: rgba(0,168,138,0.15);
            --danger: #e53e3e;
            --blue: #2563eb; --blue-glow: rgba(37,99,235,0.12); --blue-border: rgba(37,99,235,0.4);
            --timeline-bg: #f8f9fa; --timeline-grid: rgba(0,0,0,0.08); --timeline-text: #1a1a1a;
        }
        .light-mode .opt { color: #1e40af; }
        .light-mode .opt.active { color: var(--accent); }
        .light-mode .btn { color: #1e40af; }
        .light-mode .day { color: #1e40af; }
        .light-mode .day.active { color: var(--accent); }
        .light-mode .sched-btn { color: #1e40af; }
        .light-mode .sched-btn.danger { color: var(--danger); }
        .light-mode .auth-btn { color: #1e40af; }
        .light-mode .session-info { color: rgba(255,255,255,0.6); }
        .light-mode .session-info a { color: rgba(255,255,255,0.6); }
        .light-mode .session-info a:hover { color: #f5f5f5; }
        .light-mode .program-tab { color: #1e40af; }
        .light-mode .program-tab.active { color: var(--accent); }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background: var(--bg); min-height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 20px; padding: 20px; color: var(--text); }
        .hidden { display: none !important; }
        
        .auth { text-align: center; }
        .auth-icon { width: 80px; height: 80px; border-radius: 50%; background: var(--blue-glow); border: 2px solid var(--blue); display: flex; align-items: center; justify-content: center; font-size: 36px; margin: 0 auto 24px; }
        .auth h1 { font-size: 24px; font-weight: 300; margin-bottom: 12px; }
        .auth p { font-size: 14px; color: var(--text2); max-width: 280px; margin: 0 auto 24px; }
        .auth-btn { padding: 14px 32px; border-radius: 12px; border: 1px solid var(--blue-border); background: var(--blue-glow); color: #c5e3ff; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .auth-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .auth-error { color: var(--danger); font-size: 13px; padding: 12px 20px; background: rgba(255,107,107,0.15); border-radius: 8px; margin-top: 16px; }
        .auth.invalid .auth-icon { background: rgba(255,107,107,0.1); border-color: var(--danger); }
        .loading-emoji { font-size: 40px; display: flex; align-items: center; justify-content: center; height: 100%; animation: pulse 1.5s ease-in-out infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.7; } }

        .card { background: var(--bg2); border-radius: 24px; padding: 32px 40px; text-align: center; border: 1px solid var(--border); width: min(94vw, 440px); position: relative; margin-bottom: 12px; }
        .card:last-of-type { margin-bottom: 0; }
        .theme-toggle { position: absolute; top: 20px; left: 24px; width: 32px; height: 32px; border-radius: 50%; border: 1px solid var(--blue-border); background: var(--blue-glow); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; transition: all 0.2s; color: #fbbf24; }
        .light-mode .theme-toggle { color: #6b7280; }
        .theme-toggle:hover { transform: scale(1.1); }
        .theme-toggle:active { transform: scale(0.95); }
        .heat { position: absolute; top: 20px; right: 24px; font-size: 20px; opacity: 0; transition: opacity 0.3s; }
        .heat.on { opacity: 1; animation: flicker 0.5s ease-in-out infinite alternate; }
        @keyframes flicker { 0% { opacity: 0.8; } 100% { opacity: 1; } }
        .label { font-size: 14px; text-transform: uppercase; letter-spacing: 2px; color: var(--text3); margin-bottom: 8px; font-weight: 500; }
        .current { font-size: 60px; font-weight: 200; margin-bottom: 30px; color: var(--text); line-height: 1; }
        .current span:last-child { font-size: 20px; vertical-align: top; opacity: 0.5; }
        .target-row { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .target { font-size: 36px; font-weight: 200; min-width: 110px; font-family: ui-monospace, 'SF Mono', Menlo, Consolas, monospace; line-height: 1; }
        .target span:last-child { font-size: 14px; color: var(--text3); vertical-align: top; }
        .btn { width: 50px; height: 50px; border-radius: 50%; border: 1px solid var(--blue-border); background: var(--blue-glow); color: #c5e3ff; font-size: 26px; cursor: pointer; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .section { margin-top: 28px; padding-top: 5px; }
        .btn-group { display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
        .opt { padding: 10px 16px; border-radius: 10px; border: 1px solid var(--blue-border); background: var(--blue-glow); color: #c5e3ff; font-size: 11px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .opt.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
        .opt:disabled { opacity: 0.3; cursor: not-allowed; }

        .program { padding: 24px 5px; }
        .program .label, .program .btn-group, .program .days, .program .timeline-help, .program .sched-btns, .program .clear-day-row { padding-left: 1px; padding-right: 1px; }
        
        /* Program Tabs */
        .program-tabs { display: flex; justify-content: center; margin-bottom: 20px; position: relative; }
        .program-tabs::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 90%; height: 1px; background: var(--border); }
        .program-tab { padding: 12px 24px; font-size: 13px; font-weight: 500; color: #c5e3ff; cursor: pointer; border: none; background: transparent; position: relative; transition: all 0.2s; letter-spacing: 0.5px; }
        .program-tab::after { content: ''; position: absolute; bottom: -1px; left: 0; right: 0; height: 2px; background: transparent; transition: all 0.2s; }
        .program-tab.active { color: var(--accent); }
        .program-tab.active::after { background: var(--accent); }
        .program-tab:hover:not(.active) { color: var(--text); }
        
        /* Tab Content */
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .days { display: flex; gap: 4px; margin: 16px 0; flex-wrap: wrap; justify-content: center; }
        .day { padding: 6px 10px; border-radius: 8px; border: 1px solid var(--blue-border); background: var(--blue-glow); color: #c5e3ff; font-size: 10px; font-weight: 500; cursor: pointer; }
        .day.active { background: var(--accent-glow); border-color: var(--accent); color: var(--accent); }
        .timeline { position: relative; height: 240px; background: var(--timeline-bg); border-radius: 12px; overflow: hidden; }
        .timeline canvas { display: block; cursor: crosshair; width: 100%; height: 100%; }
        .timeline-help { font-size: 12px; color: var(--text3); margin-top: 8px; }
        .sched-btns { display: flex; gap: 6px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
        .sched-btn { padding: 8px 12px; border-radius: 8px; border: 1px solid var(--blue-border); background: var(--blue-glow); color: #c5e3ff; font-size: 9px; cursor: pointer; width: 120px; }
        .sched-btn.danger { border-color: rgba(255,107,107,0.3); color: var(--danger); background: rgba(255,107,107,0.1); }
        .clear-day-row { display: flex; justify-content: center; margin-top: 8px; padding-top: 5px; }
        .sync { position: fixed; bottom: 20px; right: 20px; padding: 8px 14px; background: var(--bg2); border: 1px solid var(--border); border-radius: 20px; font-size: 11px; color: var(--text3); opacity: 0; transition: all 0.3s; }
        .sync.show { opacity: 1; }
        .sync.ok { border-color: var(--accent); color: var(--accent); }
        .sync.err { border-color: var(--danger); color: var(--danger); }
        
        .session-info { font-size: 11px; color: var(--text2); margin-top: 16px; text-align: center; }
        .session-info a { color: var(--text2); text-decoration: underline; cursor: pointer; }
        .session-info a:hover { color: var(--text); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg2); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 320px; text-align: center; }
        .modal h3 { font-size: 18px; font-weight: 500; margin-bottom: 12px; }
        .modal p { font-size: 13px; color: var(--text2); margin-bottom: 20px; line-height: 1.5; }
        .modal-btns { display: flex; gap: 12px; justify-content: center; }
        .modal-btn { padding: 10px 20px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg3); color: var(--text); font-size: 13px; cursor: pointer; transition: all 0.2s; }
        .modal-btn.danger { border-color: rgba(255,107,107,0.5); background: rgba(255,107,107,0.15); color: var(--danger); }
        .modal-btn:hover { opacity: 0.8; }
        
        .modal-help { margin-top: 16px; border-top: 1px solid var(--border); padding-top: 12px; }
        .modal-help-toggle { display: inline-flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text2); cursor: pointer; }
        .modal-help-toggle:hover { color: var(--text); }
        .modal-help-icon { width: 14px; height: 14px; border-radius: 50%; border: 1px solid currentColor; display: inline-flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 600; flex-shrink: 0; }
        .modal-help-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; }
        .modal-help-content.expanded { max-height: 300px; }
        .modal-help-text { font-size: 11px; color: var(--text2); line-height: 1.6; margin-top: 10px; padding: 10px; background: var(--bg3); border-radius: 6px; text-align: left; }
    </style>
</head>
<body>
    <div class="auth" id="auth">
        <div class="auth-icon" id="authIcon">&#x1F512;</div>
        <h1 id="authTitle">Authenticate</h1>
        <p id="authMsg">Press the button below, then press the connect button on your hub.</p>
        <button class="auth-btn" id="authBtn">Start Authentication</button>
        <div class="auth-error hidden" id="authErr"></div>
    </div>

    <div class="hidden" id="main">
        <div class="card">
            <button class="theme-toggle" id="themeToggle" title="Toggle light/dark mode">&#x2600;</button>
            <div class="heat" id="heat">&#x1F525;</div>
            <div class="label">Current Temperature</div>
            <div class="current"><span id="cur">--</span><span>&deg;C</span></div>
            <div class="label">Target Temperature</div>
            <div class="target-row">
                <button class="btn" id="dec">&minus;</button>
                <div class="target"><span id="tar">--</span><span>&deg;C</span></div>
                <button class="btn" id="inc">+</button>
            </div>
            <div class="section">
                <div class="btn-group">
                    <button class="opt active" id="modeManual">Manual</button>
                    <button class="opt" id="modeProgram">Program</button>
                </div>
            </div>
        </div>

        <div class="card program hidden" id="programPanel">
            <!-- Program Tabs -->
            <div class="program-tabs" id="programTabs">
                <button class="program-tab active" data-tab="heating">Heating Program</button>
                <button class="program-tab hidden" data-tab="hotwater" id="hotWaterTab">Hot Water Program</button>
            </div>
            
            <!-- Heating Program Tab Content -->
            <div class="tab-content active" id="heatingContent">
                <div class="label">Boost</div>
                <div class="btn-group" id="boostBtns">
                    <button class="opt active" data-boost="0">Boost<br>Off</button>
                    <button class="opt" data-boost="1">Boost<br>+1 Hr</button>
                    <button class="opt" data-boost="2">Boost<br>+2 Hrs</button>
                    <button class="opt" data-boost="3">Boost<br>+3 Hrs</button>
                </div>
                <div class="label" style="margin-top:16px">Weekly Program</div>
                <div class="days" id="heatingDays"></div>
                <div class="timeline"><canvas id="heatingCanvas"></canvas></div>
                <div class="timeline-help">Tap to add &bull; Drag to move &bull; Long-press to delete</div>
                <div class="sched-btns">
                    <button class="sched-btn" id="heatingCopyPrev">Copy Previous Day</button>
                    <button class="sched-btn" id="heatingCopyNext">Copy Next Day</button>
                </div>
                <div class="clear-day-row">
                    <button class="sched-btn danger" id="heatingClearDay">Clear Day</button>
                </div>
            </div>
            
            <!-- Hot Water Program Tab Content -->
            <div class="tab-content" id="hotWaterContent">
                <div class="label">Weekly Program</div>
                <div class="days" id="hotWaterDays"></div>
                <div class="timeline"><canvas id="hotWaterCanvas"></canvas></div>
                <div class="timeline-help">Tap to add &bull; Drag to move &bull; Long-press to delete</div>
                <div class="sched-btns">
                    <button class="sched-btn" id="hotWaterCopyPrev">Copy Previous Day</button>
                    <button class="sched-btn" id="hotWaterCopyNext">Copy Next Day</button>
                </div>
                <div class="clear-day-row">
                    <button class="sched-btn danger" id="hotWaterClearDay">Clear Day</button>
                </div>
            </div>
        </div>
        
        <div class="session-info" id="sessionInfo"></div>
        
        <div class="sync" id="sync">Saved</div>
    </div>
    
    <div class="modal-overlay hidden" id="revokeModal">
        <div class="modal">
            <h3>Revoke Access</h3>
            <p>This will log out all devices, including this one. All connected devices will need to re-authenticate.</p>
            <div class="modal-btns">
                <button class="modal-btn" id="revokeCancel">Cancel</button>
                <button class="modal-btn danger" id="revokeConfirm">Revoke All</button>
            </div>
            <div class="modal-help">
                <div class="modal-help-toggle" id="helpToggle">
                    <span class="modal-help-icon">?</span>
                    <span>Why am I seeing more devices than expected?</span>
                </div>
                <div class="modal-help-content" id="helpContent">
                    <div class="modal-help-text">
                        The device count shows how many times the authorisation process has been successfully completed, and a unique cookie is given to each device to remember it. If you manually clear your cookies and re-authorise, it counts as a new device. If the count seems too high, simply revoke all access and re-authorise your devices.
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
const API = '/api';
const DAYS = ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'];
const TEMP_MIN = 10, TEMP_MAX = 30;
const POLL_INTERVAL_MS = 5000;
const AUTH_POLL_INTERVAL_MS = 1000;
const AUTH_TIMEOUT_MS = 61000;
const SERVER_STARTING_RETRY_MS = 2000;

// Theme management
function getCookie(name) {
    const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
    return match ? match[2] : null;
}

function setCookie(name, value, days = 365) {
    const expires = new Date(Date.now() + days * 864e5).toUTCString();
    document.cookie = name + '=' + value + '; expires=' + expires + '; path=/; SameSite=Strict';
}

function initTheme() {
    const savedTheme = getCookie('theme');
    const isLight = savedTheme === 'light';
    if (isLight) {
        document.body.classList.add('light-mode');
    }
    updateThemeIcon();
}

function toggleTheme() {
    const isLight = document.body.classList.toggle('light-mode');
    setCookie('theme', isLight ? 'light' : 'dark');
    updateThemeIcon();
    if (state.heatingProgramActive) {
        drawTimeline(activeTab);
    }
}

function updateThemeIcon() {
    const toggle = document.getElementById('themeToggle');
    if (toggle) {
        const isLight = document.body.classList.contains('light-mode');
        toggle.innerHTML = isLight ? '&#x1F319;' : '&#x2600;';
        toggle.title = isLight ? 'Switch to dark mode' : 'Switch to light mode';
    }
}

initTheme();

function createDebouncer(delayMs) {
    let timer = null;
    return fn => { clearTimeout(timer); timer = setTimeout(fn, delayMs); };
}

function getHubId() {
    const raw = new URLSearchParams(location.search).get('id') || '';
    const sanitized = raw.replace(/[^a-z0-9]/g, '').substring(0, 32);
    return /^[a-z0-9]{32}$/.test(sanitized) ? sanitized : null;
}

let hubId = getHubId();
let state = { 
    cur: null, 
    tar: 21, 
    heatingProgramActive: false, 
    boostSetting: 0, 
    heatingProgram: '',
    hotWaterProgramActive: false,
    hotWaterProgram: ''
};

// Track selected day for each program type
let selectedDays = { heating: 0, hotwater: 0 };
let activeTab = 'heating';

// Separate schedules for heating and hot water
let schedules = {
    heating: [[],[],[],[],[],[],[]],
    hotwater: [[],[],[],[],[],[],[]]
};

let pollTimer = null;
let dragging = null;
let pendingChanges = {};
let sessionCount = 0;

const debouncedSave = createDebouncer(500);

const $ = id => document.getElementById(id);
const auth = $('auth'), main = $('main'), authIcon = $('authIcon'), authTitle = $('authTitle');
const authMsg = $('authMsg'), authBtn = $('authBtn'), authErr = $('authErr');
const heat = $('heat'), cur = $('cur'), tar = $('tar'), sync = $('sync');
const sessionInfo = $('sessionInfo'), revokeModal = $('revokeModal');
const helpToggle = $('helpToggle'), helpContent = $('helpContent');

// Canvas contexts for both programs
const heatingCanvas = $('heatingCanvas');
const hotWaterCanvas = $('hotWaterCanvas');
const heatingCtx = heatingCanvas.getContext('2d');
const hotWaterCtx = hotWaterCanvas.getContext('2d');

document.addEventListener('DOMContentLoaded', () => {
    const themeToggle = $('themeToggle');
    if (themeToggle) {
        themeToggle.onclick = toggleTheme;
    }
    
    $('revokeCancel').onclick = () => {
        revokeModal.classList.add('hidden');
        helpContent.classList.remove('expanded');
    };
    $('revokeConfirm').onclick = revokeAllSessions;
    
    helpToggle.onclick = () => {
        helpContent.classList.toggle('expanded');
    };
    
    // Tab switching
    document.querySelectorAll('.program-tab').forEach(tab => {
        tab.onclick = () => {
            const tabName = tab.dataset.tab;
            switchTab(tabName);
        };
    });
});

function switchTab(tabName) {
    activeTab = tabName;
    
    // Update tab buttons
    document.querySelectorAll('.program-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.tab === tabName);
    });
    
    // Update tab content
    $('heatingContent').classList.toggle('active', tabName === 'heating');
    $('hotWaterContent').classList.toggle('active', tabName === 'hotwater');
    
    // Redraw the active timeline
    requestAnimationFrame(() => {
        resizeCanvas(tabName);
        drawTimeline(tabName);
    });
}

if (!hubId) {
    authTitle.textContent = 'Invalid Hub';
    authMsg.textContent = 'Scan a valid QR code from your hub.';
    authBtn.classList.add('hidden');
    authIcon.innerHTML = '&#x26A0;';
    auth.classList.add('invalid');
} else {
    checkAuth();
}

async function checkAuth() {
    try {
        const res = await fetch(`${API}/auth/check?id=${hubId}`, { credentials: 'include' });
        const data = await res.json();
        if (data.authenticated) showMain();
    } catch (err) {
        console.error('[checkAuth]', err);
    }
}

authBtn.onclick = startAuth;

async function startAuth() {
    authBtn.disabled = true;
    authErr.classList.add('hidden');
    
    try {
        const res = await fetch(`${API}/auth/start`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ hubId })
        });
        
        if (!res.ok) {
            const data = await res.json();
            
            if (res.status === 409) {
                throw new Error('Another device is already authenticating. Please wait up to 60 seconds and try again.');
            }
            if (res.status === 425) {
                authTitle.textContent = 'Please Wait';
                authMsg.textContent = 'Server is starting up...';
                authIcon.innerHTML = '<div class="loading-emoji">‚è≥</div>';
                authBtn.classList.add('hidden');
                
                setTimeout(() => {
                    resetAuth();
                    startAuth();
                }, SERVER_STARTING_RETRY_MS);
                return;
            }
            
            throw new Error(data.error || 'Failed to start auth');
        }
        
        const { clientId } = await res.json();
        
        authTitle.textContent = 'Security Check';
        authMsg.textContent = 'Press the connect button on your hub now...';
        authBtn.classList.add('hidden');
        authIcon.innerHTML = '<div class="loading-emoji">üëá</div>';
        
        const start = Date.now();
        const poll = setInterval(async () => {
            if (Date.now() - start > AUTH_TIMEOUT_MS) {
                clearInterval(poll);
                resetAuth('Timed out. Try again.');
                return;
            }
            try {
                const r = await fetch(`${API}/auth/poll?id=${hubId}&clientId=${clientId}`, { credentials: 'include' });
                const d = await r.json();
                if (d.status === 'authenticated') {
                    clearInterval(poll);
                    authIcon.innerHTML = '&#x2713;';
                    authTitle.textContent = 'Connected!';
                    authMsg.textContent = '';
                    setTimeout(showMain, 1000);
                } else if (d.status === 'timeout' || d.status === 'expired') {
                    clearInterval(poll);
                    resetAuth('Timed out. Try again.');
                } else if (d.status === 'error') {
                    clearInterval(poll);
                    resetAuth(d.error || 'Authentication error');
                }
            } catch (err) {
                console.error('[authPoll]', err);
            }
        }, AUTH_POLL_INTERVAL_MS);
    } catch (err) {
        console.error('[startAuth]', err);
        resetAuth(err.message || 'Failed to start');
    }
}

function resetAuth(err) {
    authIcon.innerHTML = '&#x1F512;';
    authTitle.textContent = 'Authenticate';
    authMsg.textContent = 'Press the button below, then press the auth button on your hub.';
    authBtn.classList.remove('hidden');
    authBtn.disabled = false;
    if (err) {
        authErr.textContent = err;
        authErr.classList.remove('hidden');
    }
}

function showMain() {
    auth.classList.add('hidden');
    main.classList.remove('hidden');
    initDays('heating', $('heatingDays'));
    initDays('hotwater', $('hotWaterDays'));
    setupCanvasEvents(heatingCanvas, 'heating');
    setupCanvasEvents(hotWaterCanvas, 'hotwater');
    fetchState();
    fetchSessionCount();
    pollTimer = setInterval(() => {
        fetchState();
        fetchSessionCount();
    }, POLL_INTERVAL_MS);
}

async function fetchState() {
    try {
        const res = await fetch(`${API}/hub/${hubId}`, { credentials: 'include' });
        if (!res.ok) {
            const data = await res.json();
            if (data.needsAuth) { location.reload(); return; }
            throw new Error(data.error || `HTTP ${res.status}`);
        }
        const d = await res.json();
        
        if (!('set_temp' in pendingChanges)) state.tar = d.set_temp;
        if (!('heating_program_active' in pendingChanges)) state.heatingProgramActive = d.heating_program_active;
        if (!('boost_setting' in pendingChanges)) state.boostSetting = d.boost_setting;
        if (!('heating_program' in pendingChanges)) decodeProgram(d.heating_program, 'heating');
        
        // Hot water state
        state.hotWaterProgramActive = d.hot_water_program_active;
        if (!('hot_water_program' in pendingChanges)) decodeProgram(d.hot_water_program, 'hotwater');
        
        state.cur = d.current_temp;
        
        render();
    } catch (err) {
        console.error('[fetchState]', err);
    }
}

async function fetchSessionCount() {
    try {
        const res = await fetch(`${API}/hub/${hubId}/sessions`, { credentials: 'include' });
        if (!res.ok) return;
        const data = await res.json();
        sessionCount = data.count || 0;
        updateSessionInfo();
    } catch (err) {
        console.error('[fetchSessionCount]', err);
    }
}

function updateSessionInfo() {
    const deviceWord = sessionCount === 1 ? 'device' : 'devices';
    sessionInfo.innerHTML = `There ${sessionCount === 1 ? 'is' : 'are'} currently <strong>${sessionCount}</strong> ${deviceWord} authorised on your hub.<br> <a id="revokeLink">Revoke all access<br></a>`;
    $('revokeLink').onclick = () => revokeModal.classList.remove('hidden');
}

async function revokeAllSessions() {
    revokeModal.classList.add('hidden');
    helpContent.classList.remove('expanded');
    
    try {
        const res = await fetch(`${API}/hub/${hubId}/sessions`, {
            method: 'DELETE',
            credentials: 'include'
        });
        
        if (res.ok) {
            location.reload();
        } else {
            const data = await res.json();
            alert(data.error || 'Failed to revoke sessions');
        }
    } catch (err) {
        console.error('[revokeAllSessions]', err);
        alert('Failed to revoke sessions');
    }
}

function showSync(ok) {
    sync.className = 'sync show ' + (ok ? 'ok' : 'err');
    sync.textContent = ok ? '\u2713 Saved' : '\u2717 Failed';
    setTimeout(() => sync.classList.remove('show'), 2000);
}

function save(updates) {
    Object.assign(pendingChanges, updates);
    
    debouncedSave(async () => {
        const toSave = { ...pendingChanges };
        
        try {
            const res = await fetch(`${API}/hub/${hubId}`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(toSave),
                credentials: 'include'
            });
            if (!res.ok) {
                const data = await res.json();
                if (data.needsAuth) { location.reload(); return; }
                throw new Error(data.error || `HTTP ${res.status}`);
            }
            showSync(true);
            
            for (const key of Object.keys(toSave)) {
                if (JSON.stringify(pendingChanges[key]) === JSON.stringify(toSave[key])) {
                    delete pendingChanges[key];
                }
            }
        } catch (err) {
            console.error('[save]', err);
            showSync(false);
            pendingChanges = {};
        }
    });
}

function render() {
    cur.textContent = state.cur !== null ? state.cur : '--';
    tar.textContent = state.tar;
    heat.classList.toggle('on', state.cur !== null && state.cur < state.tar);
    
    document.querySelectorAll('[data-boost]').forEach(b => {
        b.classList.toggle('active', parseInt(b.dataset.boost) === state.boostSetting);
    });
    
    $('modeManual').classList.toggle('active', !state.heatingProgramActive);
    $('modeProgram').classList.toggle('active', state.heatingProgramActive);
    $('programPanel').classList.toggle('hidden', !state.heatingProgramActive);
    
    // Show/hide hot water tab based on hot_water_program_active
    $('hotWaterTab').classList.toggle('hidden', !state.hotWaterProgramActive);
    
    // If hot water is disabled and we're on that tab, switch to heating
    if (!state.hotWaterProgramActive && activeTab === 'hotwater') {
        switchTab('heating');
    }
    
    if (state.heatingProgramActive && dragging === null) {
        requestAnimationFrame(() => {
            resizeCanvas(activeTab);
            drawTimeline(activeTab);
        });
    }
}

$('dec').onclick = () => {
    if (state.tar > TEMP_MIN) { state.tar--; render(); save({ set_temp: state.tar }); }
};

$('inc').onclick = () => {
    if (state.tar < TEMP_MAX) { state.tar++; render(); save({ set_temp: state.tar }); }
};

document.querySelectorAll('[data-boost]').forEach(b => {
    b.onclick = () => { state.boostSetting = parseInt(b.dataset.boost); render(); save({ boost_setting: state.boostSetting }); };
});

$('modeManual').onclick = () => { state.heatingProgramActive = false; state.boostSetting = 0; render(); save({ heating_program_active: false, boost_setting: 0 }); };

$('modeProgram').onclick = () => { state.heatingProgramActive = true; render(); save({ heating_program_active: true }); };

function initDays(programType, container) {
    container.innerHTML = '';
    DAYS.forEach((d, i) => {
        const btn = document.createElement('button');
        btn.className = 'day' + (i === 0 ? ' active' : '');
        btn.textContent = d;
        btn.onclick = () => {
            container.querySelectorAll('.day').forEach(x => x.classList.remove('active'));
            btn.classList.add('active');
            selectedDays[programType] = i;
            drawTimeline(programType);
        };
        container.appendChild(btn);
    });
}

function cleanupSchedule(programType, day) {
    const pts = schedules[programType][day].slice().sort((a, b) => a.hour - b.hour);
    if (pts.length <= 1) { schedules[programType][day] = pts; return; }
    const cleaned = [pts[0]];
    for (let i = 1; i < pts.length; i++) {
        if (pts[i].temp !== cleaned[cleaned.length - 1].temp) cleaned.push(pts[i]);
    }
    schedules[programType][day] = cleaned;
}

function decodeProgram(prog, programType) {
    schedules[programType] = [[],[],[],[],[],[],[]];
    if (!prog || prog.length !== 168) return;
    for (let d = 0; d < 7; d++) {
        let lastTemp = null;
        for (let h = 0; h < 24; h++) {
            const temp = prog.charCodeAt(d * 24 + h) - 65 + TEMP_MIN;
            if (temp !== lastTemp) {
                schedules[programType][d].push({ hour: h, temp: Math.max(TEMP_MIN, Math.min(TEMP_MAX, temp)) });
                lastTemp = temp;
            }
        }
    }
}

function encodeProgram(programType) {
    let prog = '';
    for (let d = 0; d < 7; d++) {
        const pts = schedules[programType][d].slice().sort((a, b) => a.hour - b.hour);
        let curTemp = pts.length > 0 ? pts[0].temp : 21;
        let ptIdx = 0;
        for (let h = 0; h < 24; h++) {
            while (ptIdx < pts.length && pts[ptIdx].hour <= h) { curTemp = pts[ptIdx].temp; ptIdx++; }
            prog += String.fromCharCode(Math.max(TEMP_MIN, Math.min(TEMP_MAX, curTemp)) - TEMP_MIN + 65);
        }
    }
    return prog;
}

function getCanvas(programType) {
    return programType === 'heating' ? heatingCanvas : hotWaterCanvas;
}

function getCtx(programType) {
    return programType === 'heating' ? heatingCtx : hotWaterCtx;
}

function resizeCanvas(programType) {
    const canvas = getCanvas(programType);
    const ctx = getCtx(programType);
    const container = canvas.parentElement;
    const w = container.offsetWidth, h = container.offsetHeight;
    if (w === 0 || h === 0) {
        requestAnimationFrame(() => resizeCanvas(programType));
        return;
    }
    const dpr = devicePixelRatio || 1;
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.width = w + 'px';
    canvas.style.height = h + 'px';
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
}

function getArea(programType) {
    const canvas = getCanvas(programType);
    const w = canvas.offsetWidth, h = canvas.offsetHeight;
    return { l: w * 0.08, r: w * 0.98, t: h * 0.06, b: h * 0.88 };
}

function hourToX(h, programType) { const a = getArea(programType); return a.l + (h / 24) * (a.r - a.l); }
function tempToY(t, programType) { const a = getArea(programType); return a.b - ((t - TEMP_MIN) / (TEMP_MAX - TEMP_MIN)) * (a.b - a.t); }
function xToHour(x, programType) { const a = getArea(programType); return Math.max(0, Math.min(24, ((x - a.l) / (a.r - a.l)) * 24)); }
function yToTemp(y, programType) { const a = getArea(programType); return Math.max(TEMP_MIN, Math.min(TEMP_MAX, TEMP_MIN + ((a.b - y) / (a.b - a.t)) * (TEMP_MAX - TEMP_MIN))); }

function getComputedColor(varName) {
    return getComputedStyle(document.body).getPropertyValue(varName).trim();
}

function drawTimeline(programType) {
    const canvas = getCanvas(programType);
    const ctx = getCtx(programType);
    const selectedDay = selectedDays[programType];
    
    const dpr = devicePixelRatio || 1;
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    const a = getArea(programType);
    const h = canvas.offsetHeight;
    
    const gridColor = getComputedColor('--timeline-grid');
    const textColor = getComputedColor('--timeline-text');
    const lineColor = getComputedColor('--blue');
    
    ctx.strokeStyle = gridColor;
    ctx.lineWidth = 1;
    for (let hr = 0; hr <= 24; hr++) { ctx.beginPath(); ctx.moveTo(hourToX(hr, programType), a.t); ctx.lineTo(hourToX(hr, programType), a.b); ctx.stroke(); }
    for (let t = TEMP_MIN; t <= TEMP_MAX; t++) { ctx.beginPath(); ctx.moveTo(a.l, tempToY(t, programType)); ctx.lineTo(a.r, tempToY(t, programType)); ctx.stroke(); }
    
    ctx.fillStyle = textColor;
    ctx.font = `bold ${Math.max(9, h * 0.04)}px ui-monospace, Menlo, Consolas, monospace`;
    ctx.textAlign = 'center';
    for (let hr = 0; hr <= 24; hr += 2) ctx.fillText(hr, hourToX(hr, programType), a.b + h * 0.06);
    ctx.textAlign = 'right';
    for (let t = TEMP_MIN; t <= TEMP_MAX; t += 2) ctx.fillText(t + '\u00B0', a.l - 4, tempToY(t, programType) + 3);
    
    const pts = (schedules[programType][selectedDay] || []).slice().sort((a, b) => a.hour - b.hour);
    if (pts.length > 0) {
        ctx.strokeStyle = lineColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(hourToX(0, programType), tempToY(pts[0].temp, programType));
        for (let i = 0; i < pts.length; i++) {
            ctx.lineTo(hourToX(pts[i].hour, programType), tempToY(i === 0 ? pts[0].temp : pts[i-1].temp, programType));
            ctx.lineTo(hourToX(pts[i].hour, programType), tempToY(pts[i].temp, programType));
        }
        ctx.lineTo(hourToX(24, programType), tempToY(pts[pts.length - 1].temp, programType));
        ctx.stroke();
        
        pts.forEach(p => {
            const x = hourToX(p.hour, programType), y = tempToY(p.temp, programType);
            ctx.beginPath(); ctx.arc(x, y, 6, 0, Math.PI * 2); ctx.fillStyle = getComputedColor('--blue-glow'); ctx.fill();
            ctx.strokeStyle = lineColor; ctx.lineWidth = 2; ctx.stroke();
            ctx.beginPath(); ctx.arc(x, y, 3, 0, Math.PI * 2); ctx.fillStyle = '#5ba8e8'; ctx.fill();
        });
        
        if (dragging !== null && schedules[programType][selectedDay][dragging]) {
            const dp = schedules[programType][selectedDay][dragging];
            const dx = hourToX(dp.hour, programType), dy = tempToY(dp.temp, programType);
            ctx.strokeStyle = 'rgba(128,128,128,0.4)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4, 4]);
            ctx.beginPath(); ctx.moveTo(dx, a.t); ctx.lineTo(dx, a.b); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(a.l, dy); ctx.lineTo(a.r, dy); ctx.stroke();
            ctx.setLineDash([]);
        }
    }
}

function findPoint(x, y, programType) {
    const selectedDay = selectedDays[programType];
    const pts = schedules[programType][selectedDay] || [];
    for (let i = 0; i < pts.length; i++) {
        const dx = x - hourToX(pts[i].hour, programType), dy = y - tempToY(pts[i].temp, programType);
        if (Math.sqrt(dx*dx + dy*dy) < 12) return i;
    }
    return -1;
}

function getPos(e, canvas) {
    const r = canvas.getBoundingClientRect();
    const t = e.touches ? e.touches[0] || e.changedTouches[0] : e;
    return { x: t.clientX - r.left, y: t.clientY - r.top };
}

function setupCanvasEvents(canvas, programType) {
    let longPress = null, longFired = false;
    
    const getProgramKey = () => programType === 'heating' ? 'heating_program' : 'hot_water_program';
    
    canvas.onmousedown = e => {
        const p = getPos(e, canvas), a = getArea(programType);
        const selectedDay = selectedDays[programType];
        if (p.x < a.l || p.x > a.r || p.y < a.t || p.y > a.b) return;
        const i = findPoint(p.x, p.y, programType);
        if (e.button === 2 && i !== -1) {
            schedules[programType][selectedDay].splice(i, 1);
            dragging = null;
            drawTimeline(programType);
            save({ [getProgramKey()]: encodeProgram(programType) });
        } else if (e.button === 0) {
            if (i !== -1) {
                dragging = i;
            } else {
                dragging = schedules[programType][selectedDay].length;
                schedules[programType][selectedDay].push({ hour: Math.round(xToHour(p.x, programType)), temp: Math.round(yToTemp(p.y, programType)) });
            }
            canvas.style.cursor = 'grabbing';
            pendingChanges[getProgramKey()] = true;
            drawTimeline(programType);
        }
    };

    canvas.onmousemove = e => {
        const p = getPos(e, canvas);
        const selectedDay = selectedDays[programType];
        if (dragging !== null) {
            schedules[programType][selectedDay][dragging] = { hour: Math.max(0, Math.min(24, Math.round(xToHour(p.x, programType)))), temp: Math.max(TEMP_MIN, Math.min(TEMP_MAX, Math.round(yToTemp(p.y, programType)))) };
            drawTimeline(programType);
        } else {
            canvas.style.cursor = findPoint(p.x, p.y, programType) !== -1 ? 'grab' : 'crosshair';
        }
    };

    canvas.onmouseup = () => {
        const selectedDay = selectedDays[programType];
        if (dragging !== null) {
            dragging = null;
            canvas.style.cursor = 'crosshair';
            cleanupSchedule(programType, selectedDay);
            drawTimeline(programType);
            save({ [getProgramKey()]: encodeProgram(programType) });
        }
    };

    canvas.onmouseleave = () => {
        const selectedDay = selectedDays[programType];
        if (dragging !== null) {
            dragging = null;
            canvas.style.cursor = 'crosshair';
            cleanupSchedule(programType, selectedDay);
            drawTimeline(programType);
            save({ [getProgramKey()]: encodeProgram(programType) });
        }
    };

    canvas.ontouchstart = e => {
        e.preventDefault();
        const p = getPos(e, canvas), a = getArea(programType);
        const selectedDay = selectedDays[programType];
        if (p.x < a.l || p.x > a.r || p.y < a.t || p.y > a.b) return;
        const i = findPoint(p.x, p.y, programType);
        longFired = false;
        if (i !== -1) {
            longPress = setTimeout(() => {
                longFired = true;
                schedules[programType][selectedDay].splice(i, 1);
                dragging = null;
                drawTimeline(programType);
                save({ [getProgramKey()]: encodeProgram(programType) });
            }, 500);
            dragging = i;
            pendingChanges[getProgramKey()] = true;
        } else {
            schedules[programType][selectedDay].push({ hour: Math.round(xToHour(p.x, programType)), temp: Math.round(yToTemp(p.y, programType)) });
            drawTimeline(programType);
            save({ [getProgramKey()]: encodeProgram(programType) });
        }
    };

    canvas.ontouchmove = e => {
        e.preventDefault();
        const selectedDay = selectedDays[programType];
        if (longPress) { clearTimeout(longPress); longPress = null; }
        if (dragging !== null && !longFired) {
            const p = getPos(e, canvas);
            schedules[programType][selectedDay][dragging] = { hour: Math.max(0, Math.min(24, Math.round(xToHour(p.x, programType)))), temp: Math.max(TEMP_MIN, Math.min(TEMP_MAX, Math.round(yToTemp(p.y, programType)))) };
            drawTimeline(programType);
        }
    };

    canvas.ontouchend = () => {
        const selectedDay = selectedDays[programType];
        if (longPress) { clearTimeout(longPress); longPress = null; }
        if (dragging !== null) {
            dragging = null;
            cleanupSchedule(programType, selectedDay);
            drawTimeline(programType);
            save({ [getProgramKey()]: encodeProgram(programType) });
        }
    };

    canvas.oncontextmenu = e => e.preventDefault();
}

// Heating schedule buttons
$('heatingCopyPrev').onclick = () => {
    const day = selectedDays.heating;
    schedules.heating[day] = schedules.heating[day === 0 ? 6 : day - 1].map(p => ({...p}));
    drawTimeline('heating');
    save({ heating_program: encodeProgram('heating') });
};

$('heatingCopyNext').onclick = () => {
    const day = selectedDays.heating;
    schedules.heating[day] = schedules.heating[day === 6 ? 0 : day + 1].map(p => ({...p}));
    drawTimeline('heating');
    save({ heating_program: encodeProgram('heating') });
};

$('heatingClearDay').onclick = () => { 
    schedules.heating[selectedDays.heating] = []; 
    drawTimeline('heating'); 
    save({ heating_program: encodeProgram('heating') }); 
};

// Hot water schedule buttons
$('hotWaterCopyPrev').onclick = () => {
    const day = selectedDays.hotwater;
    schedules.hotwater[day] = schedules.hotwater[day === 0 ? 6 : day - 1].map(p => ({...p}));
    drawTimeline('hotwater');
    save({ hot_water_program: encodeProgram('hotwater') });
};

$('hotWaterCopyNext').onclick = () => {
    const day = selectedDays.hotwater;
    schedules.hotwater[day] = schedules.hotwater[day === 6 ? 0 : day + 1].map(p => ({...p}));
    drawTimeline('hotwater');
    save({ hot_water_program: encodeProgram('hotwater') });
};

$('hotWaterClearDay').onclick = () => { 
    schedules.hotwater[selectedDays.hotwater] = []; 
    drawTimeline('hotwater'); 
    save({ hot_water_program: encodeProgram('hotwater') }); 
};

window.onresize = () => { 
    if (state.heatingProgramActive) { 
        resizeCanvas(activeTab); 
        drawTimeline(activeTab); 
    } 
};
</script>
</body>
</html>
