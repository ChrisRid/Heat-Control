<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Thermostat Control</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@200;300;400;500&family=JetBrains+Mono:wght@300;400&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #08090a;
            --bg-secondary: #111214;
            --bg-tertiary: #1a1b1e;
            --border-subtle: #2a2b2e;
            --border-accent: #3a3b3e;
            --text-primary: #f5f5f5;
            --text-secondary: rgba(255, 255, 255, 0.6);
            --text-muted: rgba(255, 255, 255, 0.4);
            --accent-primary: #00d4aa;
            --accent-secondary: #00b894;
            --accent-glow: rgba(0, 212, 170, 0.15);
            --danger: #ff6b6b;
            --danger-glow: rgba(255, 107, 107, 0.15);
            --heating: #ff9f43;
            --heating-glow: rgba(255, 159, 67, 0.2);
            --chart-line: #4facfe;
            --chart-point: #00f2fe;
        }

        body {
            font-family: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 16px;
            padding: 20px;
            color: var(--text-primary);
        }

        /* Auth Screen Styles */
        .auth-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            padding: 40px;
            text-align: center;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-icon {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-glow), transparent);
            border: 2px solid var(--accent-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 20px var(--accent-glow); }
            50% { box-shadow: 0 0 40px var(--accent-glow), 0 0 60px var(--accent-glow); }
        }

        .auth-title {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 1px;
        }

        .auth-subtitle {
            font-size: 14px;
            color: var(--text-secondary);
            max-width: 280px;
            line-height: 1.5;
        }

        .auth-timer {
            font-family: 'JetBrains Mono', monospace;
            font-size: 48px;
            font-weight: 300;
            color: var(--accent-primary);
            text-shadow: 0 0 30px var(--accent-glow);
        }

        .auth-timer.warning {
            color: var(--danger);
            text-shadow: 0 0 30px var(--danger-glow);
        }

        .auth-progress {
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
        }

        .auth-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--chart-point));
            transition: width 1s linear;
        }

        .auth-progress-bar.warning {
            background: linear-gradient(90deg, var(--danger), var(--heating));
        }

        .auth-status {
            font-size: 13px;
            color: var(--text-muted);
            min-height: 20px;
        }

        .auth-btn {
            padding: 14px 32px;
            border-radius: 12px;
            border: 1px solid var(--accent-primary);
            background: var(--accent-glow);
            color: var(--accent-primary);
            font-family: 'DM Sans', sans-serif;
            font-size: 14px;
            font-weight: 500;
            letter-spacing: 1px;
            text-transform: uppercase;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .auth-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
            box-shadow: 0 0 30px var(--accent-glow);
        }

        .auth-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .auth-error {
            color: var(--danger);
            font-size: 13px;
            padding: 12px 20px;
            background: var(--danger-glow);
            border-radius: 8px;
            border: 1px solid rgba(255, 107, 107, 0.3);
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Main App Container */
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .container.hidden {
            display: none;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-muted);
            transition: all 0.3s ease;
        }

        .connection-status.connected {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .connection-status.error {
            border-color: var(--danger);
            color: var(--danger);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        /* Thermostat Card */
        .thermostat {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 32px 40px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            position: relative;
            width: min(92vw, 420px);
            backdrop-filter: blur(10px);
        }

        .heating-indicator {
            position: absolute;
            top: 20px;
            right: 24px;
            font-size: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
            filter: drop-shadow(0 0 8px var(--heating));
        }

        .heating-indicator.active {
            opacity: 1;
            animation: flame-flicker 0.5s ease-in-out infinite alternate;
        }

        @keyframes flame-flicker {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        .current-section {
            margin-bottom: 32px;
        }

        .label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: var(--text-muted);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .current-temp {
            font-size: 72px;
            font-weight: 200;
            line-height: 1;
            background: linear-gradient(180deg, var(--text-primary), var(--text-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .current-temp .unit {
            font-size: 24px;
            vertical-align: top;
            margin-left: 2px;
            opacity: 0.5;
        }

        .target-section {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
        }

        .target-temp {
            font-size: 36px;
            font-weight: 300;
            min-width: 100px;
            font-family: 'JetBrains Mono', monospace;
        }

        .target-temp .unit {
            font-size: 14px;
            vertical-align: top;
            color: var(--text-muted);
        }

        .btn {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: 1px solid var(--border-accent);
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 22px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
        }

        .btn:hover {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: scale(1.05);
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* Boost Section */
        .boost-section {
            margin-top: 28px;
            padding-top: 24px;
            border-top: 1px solid var(--border-subtle);
        }

        .boost-group {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-top: 12px;
        }

        .boost-option {
            padding: 10px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
        }

        .boost-option:hover {
            background: var(--bg-secondary);
            border-color: var(--border-accent);
            color: var(--text-primary);
        }

        .boost-option:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .boost-option.active {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        /* Program Panel */
        .program-panel {
            background: var(--bg-secondary);
            border-radius: 24px;
            padding: 24px 32px;
            text-align: center;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            width: min(92vw, 420px);
        }

        .program-panel.expanded {
            padding: 20px;
        }

        .program-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .program-panel.expanded .program-header {
            margin-bottom: 16px;
        }

        .program-mode-controls {
            display: flex;
            gap: 8px;
        }

        .mode-btn {
            padding: 10px 20px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-family: 'DM Sans', sans-serif;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            touch-action: manipulation;
        }

        .mode-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-accent);
        }

        .mode-btn.active {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .schedule-editor {
            display: none;
        }

        .schedule-editor.visible {
            display: block;
        }

        .schedule-label {
            margin-bottom: 12px;
        }

        .day-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .day-tab {
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            touch-action: manipulation;
        }

        .day-tab:hover {
            background: var(--bg-secondary);
            color: var(--text-secondary);
        }

        .day-tab.active {
            background: var(--accent-glow);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .timeline-container {
            position: relative;
            height: 160px;
            margin: 12px auto;
            border-radius: 12px;
            overflow: hidden;
            background: var(--bg-primary);
        }

        .timeline-canvas {
            display: block;
            cursor: crosshair;
            touch-action: none;
        }

        .timeline-instructions {
            font-size: 10px;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .schedule-actions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            align-items: center;
            margin-top: 12px;
        }

        .copy-actions {
            display: flex;
            gap: 6px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .copy-day-btn,
        .clear-day-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-family: 'DM Sans', sans-serif;
            font-size: 9px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            touch-action: manipulation;
        }

        .copy-day-btn:hover {
            background: var(--bg-secondary);
            border-color: var(--border-accent);
            color: var(--text-secondary);
        }

        .clear-day-btn {
            border-color: rgba(255, 107, 107, 0.3);
            color: var(--danger);
        }

        .clear-day-btn:hover {
            background: var(--danger-glow);
            border-color: var(--danger);
        }

        /* Sync indicator */
        .sync-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 8px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            font-size: 11px;
            color: var(--text-muted);
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
        }

        .sync-indicator.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .sync-indicator.success {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .sync-indicator.error {
            border-color: var(--danger);
            color: var(--danger);
        }

        /* Responsive adjustments */
        @media (max-width: 400px) {
            .thermostat {
                padding: 24px 20px;
            }
            
            .current-temp {
                font-size: 56px;
            }
            
            .target-temp {
                font-size: 28px;
                min-width: 80px;
            }
            
            .boost-group {
                flex-wrap: wrap;
            }
            
            .boost-option {
                padding: 8px 12px;
                font-size: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-icon" id="authIcon">üîê</div>
        <h1 class="auth-title" id="authTitle">Authenticate</h1>
        <p class="auth-subtitle" id="authSubtitle">Press the authentication button on your thermostat hub to connect.</p>
        <div class="auth-timer" id="authTimer"></div>
        <div class="auth-progress" id="authProgressContainer" style="display: none;">
            <div class="auth-progress-bar" id="authProgressBar"></div>
        </div>
        <p class="auth-status" id="authStatus"></p>
        <button class="auth-btn" id="authBtn">Start Authentication</button>
        <div class="auth-error" id="authError" style="display: none;"></div>
    </div>

    <!-- Main App -->
    <div class="container hidden" id="mainApp">
        <div class="connection-status" id="connectionStatus">
            <span class="status-dot"></span>
            <span id="statusText">Connecting...</span>
        </div>

        <div class="thermostat">
            <div class="heating-indicator" id="heatingIndicator">üî•</div>
            <div class="current-section">
                <div class="label">Current Temperature</div>
                <div class="current-temp">
                    <span id="current">--</span><span class="unit">¬∞C</span>
                </div>
            </div>

            <div class="label">Target Temperature</div>
            <div class="target-section">
                <button class="btn" id="decrease">‚àí</button>
                <div class="target-temp">
                    <span id="target">--</span><span class="unit">¬∞C</span>
                </div>
                <button class="btn" id="increase">+</button>
            </div>

            <div class="boost-section">
                <div class="label">Boost</div>
                <div class="boost-group">
                    <button class="boost-option active" id="boostOff">Off</button>
                    <button class="boost-option" id="boost1">+1 Hr</button>
                    <button class="boost-option" id="boost2">+2 Hr</button>
                    <button class="boost-option" id="boost3">+3 Hr</button>
                </div>
            </div>
        </div>

        <div class="program-panel" id="programPanel">
            <div class="program-header">
                <div class="program-mode-controls">
                    <button class="mode-btn active" id="manualMode">Manual</button>
                    <button class="mode-btn" id="programMode">Program</button>
                </div>
            </div>

            <div class="schedule-editor" id="scheduleEditor">
                <div class="label schedule-label">Weekly Schedule</div>
                <div class="day-tabs" id="dayTabs">
                    <button class="day-tab active" data-day="0">Mon</button>
                    <button class="day-tab" data-day="1">Tue</button>
                    <button class="day-tab" data-day="2">Wed</button>
                    <button class="day-tab" data-day="3">Thu</button>
                    <button class="day-tab" data-day="4">Fri</button>
                    <button class="day-tab" data-day="5">Sat</button>
                    <button class="day-tab" data-day="6">Sun</button>
                </div>

                <div class="timeline-container">
                    <canvas class="timeline-canvas" id="timelineCanvas"></canvas>
                </div>

                <div class="timeline-instructions">
                    Tap to add ‚Ä¢ Drag to move ‚Ä¢ Long-press to delete
                </div>

                <div class="schedule-actions">
                    <div class="copy-actions">
                        <button class="copy-day-btn" id="copyPrevDayBtn">‚Üê Copy Previous</button>
                        <button class="copy-day-btn" id="copyNextDayBtn">Copy Next ‚Üí</button>
                    </div>
                    <button class="clear-day-btn" id="clearDayBtn">Clear Day</button>
                </div>
            </div>
        </div>

        <div class="sync-indicator" id="syncIndicator">Saved</div>
    </div>

    <script>
        // ============================================================================
        // CONFIGURATION
        // ============================================================================
        
        const API_BASE = window.location.origin + '/api';
        const POLL_INTERVAL = 30000; // Poll for updates every 30 seconds
        const AUTH_POLL_INTERVAL = 2000; // Poll auth status every 2 seconds
        const SYNC_DEBOUNCE = 1000; // Debounce sync requests by 1 second
        
        // Temperature range
        const TARGET_TEMP_MIN = 10;
        const TARGET_TEMP_MAX = 30;
        const TEMP_MIN = 15;
        const TEMP_MAX = 30;
        
        // Graph configuration
        const GRAPH_WIDTH_PERCENT = 0.95;
        const GRAPH_HEIGHT = 160;
        const CHART_MARGIN_LEFT_PERCENT = 0.11;
        const CHART_MARGIN_RIGHT_PERCENT = 0.03;
        const CHART_MARGIN_TOP_PERCENT = 0.075;
        const CHART_MARGIN_BOTTOM_PERCENT = 0.125;
        const POINT_OUTER_RADIUS = 6;
        const POINT_INNER_RADIUS = 3;
        const POINT_HIT_THRESHOLD = 12;
        const AXIS_FONT_SIZE = 8;
        const X_LABEL_OFFSET = 11;
        const Y_LABEL_OFFSET = 5;

        // ============================================================================
        // STATE
        // ============================================================================
        
        let deviceId = null;
        let isAuthenticated = false;
        let targetTemp = 21;
        let currentTemp = null;
        let boost = 0;
        let programEnabled = false;
        let selectedDay = 0;
        let schedule = [[], [], [], [], [], [], []];
        
        let pollInterval = null;
        let authPollInterval = null;
        let authClientId = null;
        let authStartTime = null;
        let syncTimeout = null;
        let draggingPoint = null;

        // ============================================================================
        // DOM ELEMENTS
        // ============================================================================
        
        const authScreen = document.getElementById('authScreen');
        const mainApp = document.getElementById('mainApp');
        const authIcon = document.getElementById('authIcon');
        const authTitle = document.getElementById('authTitle');
        const authSubtitle = document.getElementById('authSubtitle');
        const authTimer = document.getElementById('authTimer');
        const authProgressContainer = document.getElementById('authProgressContainer');
        const authProgressBar = document.getElementById('authProgressBar');
        const authStatus = document.getElementById('authStatus');
        const authBtn = document.getElementById('authBtn');
        const authError = document.getElementById('authError');
        
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');
        const targetDisplay = document.getElementById('target');
        const currentDisplay = document.getElementById('current');
        const heatingIndicator = document.getElementById('heatingIndicator');
        const decreaseBtn = document.getElementById('decrease');
        const increaseBtn = document.getElementById('increase');
        const manualModeBtn = document.getElementById('manualMode');
        const programModeBtn = document.getElementById('programMode');
        const scheduleEditor = document.getElementById('scheduleEditor');
        const programPanel = document.getElementById('programPanel');
        const dayTabs = document.getElementById('dayTabs');
        const canvas = document.getElementById('timelineCanvas');
        const ctx = canvas.getContext('2d');
        const clearDayBtn = document.getElementById('clearDayBtn');
        const boostOff = document.getElementById('boostOff');
        const boost1 = document.getElementById('boost1');
        const boost2 = document.getElementById('boost2');
        const boost3 = document.getElementById('boost3');
        const copyPrevDayBtn = document.getElementById('copyPrevDayBtn');
        const copyNextDayBtn = document.getElementById('copyNextDayBtn');
        const syncIndicator = document.getElementById('syncIndicator');

        // ============================================================================
        // API FUNCTIONS
        // ============================================================================
        
        async function apiRequest(endpoint, options = {}) {
            const url = API_BASE + endpoint;
            const config = {
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json',
                    ...options.headers
                },
                ...options
            };
            
            if (options.body && typeof options.body === 'object') {
                config.body = JSON.stringify(options.body);
            }
            
            const response = await fetch(url, config);
            const data = await response.json();
            
            if (!response.ok) {
                throw { status: response.status, ...data };
            }
            
            return data;
        }

        async function checkAuth() {
            try {
                const data = await apiRequest(`/auth/check?id=${deviceId}`);
                return data.authenticated;
            } catch (err) {
                console.error('Auth check failed:', err);
                return false;
            }
        }

        async function startAuth() {
            try {
                const data = await apiRequest('/auth/start', {
                    method: 'POST',
                    body: { deviceId }
                });
                return data;
            } catch (err) {
                throw err;
            }
        }

        async function pollAuth() {
            try {
                const data = await apiRequest(`/auth/poll?id=${deviceId}&clientId=${authClientId}`);
                return data;
            } catch (err) {
                throw err;
            }
        }

        async function getDeviceState() {
            try {
                const data = await apiRequest(`/device/${deviceId}`);
                return data;
            } catch (err) {
                if (err.needsAuth) {
                    isAuthenticated = false;
                    showAuthScreen();
                }
                throw err;
            }
        }

        async function updateDevice(updates) {
            try {
                await apiRequest(`/device/${deviceId}`, {
                    method: 'PATCH',
                    body: updates
                });
                showSyncIndicator('success');
            } catch (err) {
                showSyncIndicator('error');
                throw err;
            }
        }

        // ============================================================================
        // UI FUNCTIONS
        // ============================================================================
        
        function showAuthScreen() {
            authScreen.classList.remove('hidden');
            mainApp.classList.add('hidden');
            resetAuthUI();
        }

        function showMainApp() {
            authScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            startPolling();
        }

        function resetAuthUI() {
            authIcon.textContent = 'üîê';
            authTitle.textContent = 'Authenticate';
            authSubtitle.textContent = 'Press the authentication button on your thermostat hub to connect.';
            authTimer.textContent = '';
            authProgressContainer.style.display = 'none';
            authStatus.textContent = '';
            authBtn.textContent = 'Start Authentication';
            authBtn.disabled = false;
            authError.style.display = 'none';
            
            if (authPollInterval) {
                clearInterval(authPollInterval);
                authPollInterval = null;
            }
        }

        function showAuthError(message) {
            authError.textContent = message;
            authError.style.display = 'block';
            authBtn.disabled = false;
            authBtn.textContent = 'Try Again';
        }

        function updateAuthTimer() {
            if (!authStartTime) return;
            
            const elapsed = Date.now() - authStartTime;
            const remaining = Math.max(0, 60000 - elapsed);
            const seconds = Math.ceil(remaining / 1000);
            
            authTimer.textContent = seconds;
            
            const progress = (remaining / 60000) * 100;
            authProgressBar.style.width = progress + '%';
            
            if (seconds <= 10) {
                authTimer.classList.add('warning');
                authProgressBar.classList.add('warning');
            } else {
                authTimer.classList.remove('warning');
                authProgressBar.classList.remove('warning');
            }
        }

        function setConnectionStatus(status) {
            connectionStatus.className = 'connection-status ' + status;
            
            switch (status) {
                case 'connected':
                    statusText.textContent = 'Connected';
                    break;
                case 'error':
                    statusText.textContent = 'Connection Lost';
                    break;
                default:
                    statusText.textContent = 'Connecting...';
            }
        }

        function updateDisplay() {
            targetDisplay.textContent = targetTemp;
            currentDisplay.textContent = currentTemp !== null ? currentTemp.toFixed(1) : '--';
            
            if (currentTemp !== null && currentTemp < targetTemp) {
                heatingIndicator.classList.add('active');
            } else {
                heatingIndicator.classList.remove('active');
            }
            
            updateBoostButtons();
            updateModeButtons();
        }

        function updateBoostButtons() {
            const allBoostBtns = [boostOff, boost1, boost2, boost3];
            allBoostBtns.forEach(btn => {
                btn.disabled = !programEnabled;
                btn.classList.remove('active');
            });
            
            if (boost === 0) boostOff.classList.add('active');
            else if (boost === 1) boost1.classList.add('active');
            else if (boost === 2) boost2.classList.add('active');
            else if (boost === 3) boost3.classList.add('active');
        }

        function updateModeButtons() {
            if (programEnabled) {
                programModeBtn.classList.add('active');
                manualModeBtn.classList.remove('active');
                scheduleEditor.classList.add('visible');
                programPanel.classList.add('expanded');
            } else {
                manualModeBtn.classList.add('active');
                programModeBtn.classList.remove('active');
                scheduleEditor.classList.remove('visible');
                programPanel.classList.remove('expanded');
            }
        }

        function showSyncIndicator(type) {
            syncIndicator.className = 'sync-indicator visible ' + type;
            syncIndicator.textContent = type === 'success' ? '‚úì Saved' : '‚úó Sync Failed';
            
            setTimeout(() => {
                syncIndicator.classList.remove('visible');
            }, 2000);
        }

        // ============================================================================
        // SYNC FUNCTIONS
        // ============================================================================
        
        function debouncedSync(updates) {
            if (syncTimeout) clearTimeout(syncTimeout);
            syncTimeout = setTimeout(() => updateDevice(updates), SYNC_DEBOUNCE);
        }

        async function syncState() {
            try {
                const state = await getDeviceState();
                
                currentTemp = state.currentTemp;
                targetTemp = state.setTemp;
                boost = state.boost;
                programEnabled = state.mode === 'program';
                
                if (state.program && Array.isArray(state.program)) {
                    schedule = state.program;
                }
                
                updateDisplay();
                setConnectionStatus('connected');
                
                if (programEnabled) {
                    setTimeout(() => {
                        resizeCanvas();
                        drawTimeline();
                    }, 100);
                }
            } catch (err) {
                console.error('Sync failed:', err);
                setConnectionStatus('error');
            }
        }

        function startPolling() {
            syncState();
            if (pollInterval) clearInterval(pollInterval);
            pollInterval = setInterval(syncState, POLL_INTERVAL);
        }

        // ============================================================================
        // AUTH FLOW
        // ============================================================================
        
        async function handleAuth() {
            authBtn.disabled = true;
            authError.style.display = 'none';
            
            try {
                const result = await startAuth();
                authClientId = result.clientId;
                authStartTime = Date.now();
                
                authTitle.textContent = 'Waiting...';
                authSubtitle.textContent = 'Press the authentication button on your hub now.';
                authProgressContainer.style.display = 'block';
                authBtn.style.display = 'none';
                
                // Start timer update
                const timerInterval = setInterval(updateAuthTimer, 100);
                
                // Start polling for auth status
                authPollInterval = setInterval(async () => {
                    try {
                        const status = await pollAuth();
                        authStatus.textContent = status.message;
                        
                        if (status.status === 'authenticated') {
                            clearInterval(authPollInterval);
                            clearInterval(timerInterval);
                            authIcon.textContent = '‚úì';
                            authTitle.textContent = 'Connected!';
                            authSubtitle.textContent = 'Successfully authenticated.';
                            authTimer.textContent = '';
                            authProgressContainer.style.display = 'none';
                            
                            setTimeout(() => {
                                isAuthenticated = true;
                                showMainApp();
                            }, 1500);
                        } else if (status.status === 'timeout' || status.status === 'expired') {
                            clearInterval(authPollInterval);
                            clearInterval(timerInterval);
                            resetAuthUI();
                            showAuthError('Authentication timed out. Please try again.');
                        }
                    } catch (err) {
                        console.error('Auth poll error:', err);
                    }
                }, AUTH_POLL_INTERVAL);
                
                // Auto-timeout after 60 seconds
                setTimeout(() => {
                    if (authPollInterval) {
                        clearInterval(authPollInterval);
                        clearInterval(timerInterval);
                        authPollInterval = null;
                        resetAuthUI();
                        showAuthError('Authentication timed out. Please try again.');
                    }
                }, 62000);
                
            } catch (err) {
                console.error('Start auth failed:', err);
                showAuthError(err.error || 'Failed to start authentication');
            }
        }

        // ============================================================================
        // EVENT HANDLERS
        // ============================================================================
        
        authBtn.addEventListener('click', handleAuth);

        decreaseBtn.addEventListener('click', () => {
            if (targetTemp > TARGET_TEMP_MIN) {
                targetTemp -= 1;
                updateDisplay();
                debouncedSync({ setTemp: targetTemp });
            }
        });

        increaseBtn.addEventListener('click', () => {
            if (targetTemp < TARGET_TEMP_MAX) {
                targetTemp += 1;
                updateDisplay();
                debouncedSync({ setTemp: targetTemp });
            }
        });

        function setBoost(hours) {
            if (!programEnabled) return;
            boost = hours;
            updateBoostButtons();
            debouncedSync({ boost });
        }

        boostOff.addEventListener('click', () => setBoost(0));
        boost1.addEventListener('click', () => setBoost(1));
        boost2.addEventListener('click', () => setBoost(2));
        boost3.addEventListener('click', () => setBoost(3));

        manualModeBtn.addEventListener('click', () => {
            if (!programEnabled) return;
            programEnabled = false;
            boost = 0;
            updateDisplay();
            debouncedSync({ mode: 'manual', boost: 0 });
        });

        programModeBtn.addEventListener('click', () => {
            if (programEnabled) return;
            programEnabled = true;
            updateDisplay();
            debouncedSync({ mode: 'program' });
            
            setTimeout(() => {
                resizeCanvas();
                drawTimeline();
            }, 100);
        });

        dayTabs.addEventListener('click', (e) => {
            if (e.target.classList.contains('day-tab')) {
                document.querySelectorAll('.day-tab').forEach(tab => tab.classList.remove('active'));
                e.target.classList.add('active');
                selectedDay = parseInt(e.target.dataset.day);
                drawTimeline();
            }
        });

        clearDayBtn.addEventListener('click', () => {
            schedule[selectedDay] = [];
            drawTimeline();
            debouncedSync({ program: schedule });
        });

        copyPrevDayBtn.addEventListener('click', () => {
            const prevDay = selectedDay === 0 ? 6 : selectedDay - 1;
            schedule[selectedDay] = schedule[prevDay].map(p => ({ ...p }));
            drawTimeline();
            debouncedSync({ program: schedule });
        });

        copyNextDayBtn.addEventListener('click', () => {
            const nextDay = selectedDay === 6 ? 0 : selectedDay + 1;
            schedule[selectedDay] = schedule[nextDay].map(p => ({ ...p }));
            drawTimeline();
            debouncedSync({ program: schedule });
        });

        // ============================================================================
        // CANVAS / TIMELINE
        // ============================================================================
        
        function resizeCanvas() {
            const container = canvas.parentElement;
            const referenceWidth = programPanel.offsetWidth - 40;
            const width = Math.floor(referenceWidth * GRAPH_WIDTH_PERCENT);
            const height = GRAPH_HEIGHT;
            const dpr = window.devicePixelRatio || 1;
            
            container.style.width = width + 'px';
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            canvas.style.width = width + 'px';
            canvas.style.height = height + 'px';
            ctx.scale(dpr, dpr);
        }

        function getChartArea() {
            const container = canvas.parentElement;
            const width = container.offsetWidth;
            const height = GRAPH_HEIGHT;
            return {
                left: Math.round(width * CHART_MARGIN_LEFT_PERCENT),
                right: Math.round(width * (1 - CHART_MARGIN_RIGHT_PERCENT)),
                top: Math.round(height * CHART_MARGIN_TOP_PERCENT),
                bottom: Math.round(height * (1 - CHART_MARGIN_BOTTOM_PERCENT))
            };
        }

        function hourToX(hour) {
            const area = getChartArea();
            return area.left + (hour / 24) * (area.right - area.left);
        }

        function tempToY(temp) {
            const area = getChartArea();
            return area.bottom - ((temp - TEMP_MIN) / (TEMP_MAX - TEMP_MIN)) * (area.bottom - area.top);
        }

        function xToHour(x) {
            const area = getChartArea();
            return Math.max(0, Math.min(24, ((x - area.left) / (area.right - area.left)) * 24));
        }

        function yToTemp(y) {
            const area = getChartArea();
            return Math.max(TEMP_MIN, Math.min(TEMP_MAX, TEMP_MIN + ((area.bottom - y) / (area.bottom - area.top)) * (TEMP_MAX - TEMP_MIN)));
        }

        function drawTimeline() {
            const dpr = window.devicePixelRatio || 1;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.scale(dpr, dpr);
            
            const area = getChartArea();

            // Grid
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
            ctx.lineWidth = 1;

            for (let h = 0; h <= 24; h++) {
                const x = hourToX(h);
                ctx.beginPath();
                ctx.moveTo(x, area.top);
                ctx.lineTo(x, area.bottom);
                ctx.stroke();
            }

            for (let t = TEMP_MIN; t <= TEMP_MAX; t++) {
                const y = tempToY(t);
                ctx.beginPath();
                ctx.moveTo(area.left, y);
                ctx.lineTo(area.right, y);
                ctx.stroke();
            }

            // Axis labels
            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            ctx.font = AXIS_FONT_SIZE + 'px "JetBrains Mono", monospace';
            ctx.textAlign = 'center';

            for (let h = 0; h <= 24; h += 2) {
                ctx.fillText(h.toString().padStart(2, '0'), hourToX(h), area.bottom + X_LABEL_OFFSET);
            }

            ctx.textAlign = 'right';
            for (let t = TEMP_MIN; t <= TEMP_MAX; t += 3) {
                ctx.fillText(t + '¬∞', area.left - Y_LABEL_OFFSET, tempToY(t) + 3);
            }

            // Schedule line
            const points = (schedule[selectedDay] || []).slice().sort((a, b) => a.hour - b.hour);
            
            if (points.length > 0) {
                // Create gradient
                const gradient = ctx.createLinearGradient(area.left, 0, area.right, 0);
                gradient.addColorStop(0, '#4facfe');
                gradient.addColorStop(1, '#00f2fe');
                
                ctx.strokeStyle = gradient;
                ctx.lineWidth = 2;
                ctx.beginPath();

                const firstTemp = points[0].temp;
                ctx.moveTo(hourToX(0), tempToY(firstTemp));

                for (let i = 0; i < points.length; i++) {
                    const point = points[i];
                    ctx.lineTo(hourToX(point.hour), tempToY(i === 0 ? firstTemp : points[i-1].temp));
                    ctx.lineTo(hourToX(point.hour), tempToY(point.temp));
                }

                ctx.lineTo(hourToX(24), tempToY(points[points.length - 1].temp));
                ctx.stroke();

                // Points
                points.forEach(point => {
                    const x = hourToX(point.hour);
                    const y = tempToY(point.temp);

                    ctx.beginPath();
                    ctx.arc(x, y, POINT_OUTER_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = 'rgba(79, 172, 254, 0.2)';
                    ctx.fill();
                    ctx.strokeStyle = '#4facfe';
                    ctx.lineWidth = 2;
                    ctx.stroke();

                    ctx.beginPath();
                    ctx.arc(x, y, POINT_INNER_RADIUS, 0, Math.PI * 2);
                    ctx.fillStyle = '#00f2fe';
                    ctx.fill();
                });
            }
        }

        function findPointNear(x, y, threshold = POINT_HIT_THRESHOLD) {
            const points = schedule[selectedDay] || [];
            for (let i = 0; i < points.length; i++) {
                const px = hourToX(points[i].hour);
                const py = tempToY(points[i].temp);
                const dist = Math.sqrt((x - px) ** 2 + (y - py) ** 2);
                if (dist < threshold) return i;
            }
            return -1;
        }

        function getMousePos(e) {
            const rect = canvas.getBoundingClientRect();
            return { x: e.clientX - rect.left, y: e.clientY - rect.top };
        }

        function getTouchPos(e) {
            const rect = canvas.getBoundingClientRect();
            const touch = e.touches[0] || e.changedTouches[0];
            return { x: touch.clientX - rect.left, y: touch.clientY - rect.top };
        }

        canvas.addEventListener('mousedown', (e) => {
            const pos = getMousePos(e);
            const area = getChartArea();

            if (pos.x < area.left || pos.x > area.right || pos.y < area.top || pos.y > area.bottom) return;

            const pointIndex = findPointNear(pos.x, pos.y);

            if (e.button === 2) {
                if (pointIndex !== -1) {
                    schedule[selectedDay].splice(pointIndex, 1);
                    drawTimeline();
                    debouncedSync({ program: schedule });
                }
            } else if (e.button === 0) {
                if (pointIndex !== -1) {
                    draggingPoint = pointIndex;
                    canvas.style.cursor = 'grabbing';
                } else {
                    const hour = Math.round(xToHour(pos.x));
                    const temp = Math.round(yToTemp(pos.y));
                    if (!schedule[selectedDay]) schedule[selectedDay] = [];
                    schedule[selectedDay].push({ hour, temp });
                    drawTimeline();
                    debouncedSync({ program: schedule });
                }
            }
        });

        canvas.addEventListener('mousemove', (e) => {
            const pos = getMousePos(e);
            
            if (draggingPoint !== null) {
                const hour = Math.max(0, Math.min(24, Math.round(xToHour(pos.x))));
                const temp = Math.max(TEMP_MIN, Math.min(TEMP_MAX, Math.round(yToTemp(pos.y))));
                schedule[selectedDay][draggingPoint] = { hour, temp };
                drawTimeline();
            } else {
                const pointIndex = findPointNear(pos.x, pos.y);
                canvas.style.cursor = pointIndex !== -1 ? 'grab' : 'crosshair';
            }
        });

        canvas.addEventListener('mouseup', () => {
            if (draggingPoint !== null) {
                debouncedSync({ program: schedule });
                draggingPoint = null;
                canvas.style.cursor = 'crosshair';
            }
        });

        canvas.addEventListener('mouseleave', () => {
            if (draggingPoint !== null) {
                debouncedSync({ program: schedule });
                draggingPoint = null;
                canvas.style.cursor = 'crosshair';
            }
        });

        // Touch events
        let longPressTimer = null;
        let longPressTriggered = false;

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            const pos = getTouchPos(e);
            const area = getChartArea();

            if (pos.x < area.left || pos.x > area.right || pos.y < area.top || pos.y > area.bottom) return;

            const pointIndex = findPointNear(pos.x, pos.y);
            longPressTriggered = false;

            if (pointIndex !== -1) {
                longPressTimer = setTimeout(() => {
                    longPressTriggered = true;
                    schedule[selectedDay].splice(pointIndex, 1);
                    draggingPoint = null;
                    drawTimeline();
                    debouncedSync({ program: schedule });
                }, 500);
                draggingPoint = pointIndex;
            } else {
                const hour = Math.round(xToHour(pos.x));
                const temp = Math.round(yToTemp(pos.y));
                if (!schedule[selectedDay]) schedule[selectedDay] = [];
                schedule[selectedDay].push({ hour, temp });
                drawTimeline();
                debouncedSync({ program: schedule });
            }
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (draggingPoint !== null && !longPressTriggered) {
                const pos = getTouchPos(e);
                const hour = Math.max(0, Math.min(24, Math.round(xToHour(pos.x))));
                const temp = Math.max(TEMP_MIN, Math.min(TEMP_MAX, Math.round(yToTemp(pos.y))));
                schedule[selectedDay][draggingPoint] = { hour, temp };
                drawTimeline();
            }
        }, { passive: false });

        canvas.addEventListener('touchend', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (draggingPoint !== null) {
                debouncedSync({ program: schedule });
                draggingPoint = null;
            }
        });

        canvas.addEventListener('touchcancel', () => {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (draggingPoint !== null) {
                draggingPoint = null;
            }
        });

        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        window.addEventListener('resize', () => {
            if (programEnabled && !authScreen.classList.contains('hidden') === false) {
                resizeCanvas();
                drawTimeline();
            }
        });

        // ============================================================================
        // INITIALIZATION
        // ============================================================================
        
        async function init() {
            // Get device ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            deviceId = urlParams.get('id');
            
            if (!deviceId || !/^[a-z0-9]{32}$/.test(deviceId)) {
                authTitle.textContent = 'Invalid Device';
                authSubtitle.textContent = 'Please scan a valid QR code from your thermostat hub.';
                authBtn.style.display = 'none';
                authIcon.textContent = '‚ö†Ô∏è';
                return;
            }
            
            // Check if already authenticated
            const authenticated = await checkAuth();
            
            if (authenticated) {
                isAuthenticated = true;
                showMainApp();
            } else {
                showAuthScreen();
            }
        }

        init();
    </script>
</body>
</html>
